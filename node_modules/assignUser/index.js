var mongo = require('mongodb');
var monk = require('monk');
var db = monk('localhost:27017/expresstest');

var users = db.get('usercollection');
var questions = db.get('questions');

function assignUserToQuestion(question){
	mongo.connect('mongodb://localhost:27017/expresstest',function(err,dbPure){
		coll = dbPure.collection('usercollection');
		coll.stats(function(err, stats){
			var randomUsers = Math.floor(Math.random()*stats.count);
			console.log(randomUsers);
			users.find({},{skip:randomUsers},function(e,docs){
				var chosenUser = docs[0];
				console.log("user"+chosenUser._id);				
			
				questions.update(question._id, {$set:{assignedUser:chosenUser._id}});
			});
		});	
	});
}

function insertQuestionRandom(question){
	questions.insert({text:question.text, topic:question.topic, title:question.title}, function(err,doc){
		assignUserToQuestion(doc);
	});
}

function getAssignedQuestions(username,callback){
	console.log('jo');
	users.findOne({username:username},{},function(err, user){
		if(err){
			callback(err,null);
		}
		else{
			questions.find({assignedUser:user._id},{},function(err, docs){
				callback(err,docs);
			});
		}
	});
}

exports.getAssignedQuestions = getAssignedQuestions;
exports.insertQuestionRandom = insertQuestionRandom;
exports.assignUserRandom = assignUserToQuestion;